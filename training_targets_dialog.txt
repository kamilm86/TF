from PySide6.QtWidgets import (QDialog, QVBoxLayout, QHBoxLayout, QTableWidget, QTableWidgetItem, 
                               QPushButton, QHeaderView, QMessageBox, QInputDialog, QDoubleSpinBox, QSpinBox, 
                               QLabel, QWidget)
from PySide6.QtCore import Qt
import json
from app_settings import app_settings
from db_connector import save_app_setting
from debug_utils import debug_print

class TrainingTargetsDialog(QDialog):
    """
    Okno dialogowe do konfiguracji celów szkoleniowych (TrainingTargets).
    Zapisuje zmiany w bazie danych (tabela appsettings) oraz aktualizuje lokalny singleton app_settings.
    """
    def __init__(self, parent=None):
        super().__init__(parent)
        self.setWindowTitle("Konfiguracja Celów Szkoleniowych")
        self.resize(700, 500)
        
        # Kopia robocza danych z app_settings
        self.targets = app_settings.TRAINING_TARGETS.copy()
        
        self.setup_ui()
        self.load_data()

    def setup_ui(self):
        layout = QVBoxLayout(self)
        
        info_lbl = QLabel("Zdefiniuj wymagania (godziny, dni) dla poszczególnych tagów szkoleń (np. WSTĘPNE, BHP).")
        info_lbl.setWordWrap(True)
        layout.addWidget(info_lbl)

        # Tabela
        self.table = QTableWidget()
        self.table.setColumnCount(4)
        self.table.setHorizontalHeaderLabels(["TAG (Kod)", "Pełna Nazwa", "Min. Godziny", "Min. Dni"])
        header = self.table.horizontalHeader()
        header.setSectionResizeMode(0, QHeaderView.ResizeToContents)
        header.setSectionResizeMode(1, QHeaderView.Stretch)
        header.setSectionResizeMode(2, QHeaderView.ResizeToContents)
        header.setSectionResizeMode(3, QHeaderView.ResizeToContents)
        layout.addWidget(self.table)

        # Przyciski akcji
        btn_layout = QHBoxLayout()
        
        add_btn = QPushButton("+ Dodaj Cel")
        add_btn.clicked.connect(self.add_target)
        
        del_btn = QPushButton("- Usuń Zaznaczone")
        del_btn.clicked.connect(self.delete_target)
        
        btn_layout.addWidget(add_btn)
        btn_layout.addWidget(del_btn)
        btn_layout.addStretch()
        
        layout.addLayout(btn_layout)

        # Przyciski Dialogu
        dialog_btns = QHBoxLayout()
        save_btn = QPushButton("Zapisz i Zamknij")
        save_btn.clicked.connect(self.save_and_close)
        
        cancel_btn = QPushButton("Anuluj")
        cancel_btn.clicked.connect(self.reject)
        
        dialog_btns.addStretch()
        dialog_btns.addWidget(save_btn)
        dialog_btns.addWidget(cancel_btn)
        
        layout.addLayout(dialog_btns)

    def load_data(self):
        self.table.setRowCount(0)
        
        # Sortujemy po Tagu
        sorted_tags = sorted(self.targets.keys())
        
        for row, tag in enumerate(sorted_tags):
            data = self.targets[tag]
            self.add_row_to_table(tag, data)

    def add_row_to_table(self, tag, data):
        row = self.table.rowCount()
        self.table.insertRow(row)

        # Tag (Read Only w tabeli, bo to klucz)
        item_tag = QTableWidgetItem(tag)
        item_tag.setFlags(item_tag.flags() ^ Qt.ItemIsEditable) # Read only
        self.table.setItem(row, 0, item_tag)
        
        # Name
        item_name = QTableWidgetItem(data.get('name', ''))
        self.table.setItem(row, 1, item_name)
        
        # Hours (Double SpinBox)
        sb_hours = QDoubleSpinBox()
        sb_hours.setRange(0, 9999)
        sb_hours.setDecimals(1)
        sb_hours.setValue(float(data.get('hours', 8.0)))
        # Przechowujemy oryginalny tag w widgecie, żeby łatwiej znaleźć
        sb_hours.setProperty("row_tag", tag)
        self.table.setCellWidget(row, 2, sb_hours)

        # Days (SpinBox)
        sb_days = QSpinBox()
        sb_days.setRange(0, 365)
        sb_days.setValue(int(data.get('days', 1)))
        self.table.setCellWidget(row, 3, sb_days)

    def add_target(self):
        tag, ok = QInputDialog.getText(self, "Nowy Cel", "Podaj TAG (kategorię), np. WSTĘPNE:")
        if ok and tag:
            tag = tag.strip().upper().replace("#", "") # Usuwamy # jeśli user wpisał
            if not tag:
                return
            
            if tag in self.targets:
                QMessageBox.warning(self, "Błąd", f"Cel dla tagu '{tag}' już istnieje.")
                return

            # Default data for new
            self.targets[tag] = {"hours": 8.0, "days": 1, "name": f"Szkolenie {tag}"}
            
            # Odśwież tabelę (prościej niż dodawać manualnie i dbać o kolejność, choć mniej wydajnie)
            self.load_data()
            
            # Zaznacz nowy wiersz
            items = self.table.findItems(tag, Qt.MatchExactly)
            if items:
                self.table.setCurrentItem(items[0])

    def delete_target(self):
        current_row = self.table.currentRow()
        if current_row < 0:
            return
            
        tag_item = self.table.item(current_row, 0)
        tag = tag_item.text()
        
        resp = QMessageBox.question(self, "Potwierdź", f"Czy na pewno usunąć konfigurację dla '{tag}'?")
        if resp == QMessageBox.Yes:
            if tag in self.targets:
                del self.targets[tag]
            self.table.removeRow(current_row)

    def save_and_close(self):
        # Pobierz dane z tabeli do słownika self.targets
        new_targets_state = {}
        
        for row in range(self.table.rowCount()):
            tag_item = self.table.item(row, 0)
            tag = tag_item.text()
            
            name_item = self.table.item(row, 1)
            name = name_item.text().strip()
            
            sb_hours = self.table.cellWidget(row, 2)
            hours = sb_hours.value()
            
            sb_days = self.table.cellWidget(row, 3)
            days = sb_days.value()
            
            new_targets_state[tag] = {
                "hours": hours,
                "days": days,
                "name": name
            }
            
        # Zapisz do bazy
        json_str = json.dumps(new_targets_state, indent=4)
        success = save_app_setting("TrainingTargets", json_str)
        
        if success:
            # Zaktualizuj singleton
            app_settings.TRAINING_TARGETS = new_targets_state
            
            QMessageBox.information(self, "Sukces", "Konfiguracja celów została zapisana.")
            self.accept()
        else:
            QMessageBox.critical(self, "Błąd", "Nie udało się zapisać konfiguracji w bazie danych.")
