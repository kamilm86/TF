# ribbon_controller.py
from PySide6.QtWidgets import (QWidget, QVBoxLayout, QHBoxLayout, QPushButton, QLabel, QComboBox, 
                               QFrame, QSizePolicy, QStyle)
from PySide6.QtGui import QIcon, QPixmap, QPainter, QPen, QColor, QImageReader
from PySide6.QtCore import Qt, QSize
from datetime import datetime
from config import resource_path
from app_settings import app_settings
from debug_utils import log_error, debug_print

class RibbonController:
    """
    Kontroler odpowiedzialny za gÃ³rny pasek narzÄ™dzi (Ribbon) aplikacji.
    Wydzielony z main.py w celu uporzÄ…dkowania kodu.
    """
    def __init__(self, main_window):
        self.main_window = main_window

        
        # DEBUG: SprawdÅº obsÅ‚ugiwane formaty
        formats = [fmt.data().decode() for fmt in QImageReader.supportedImageFormats()]
        debug_print(f"Supported Image Formats: {formats}")

        # The setup_top_bar method will be called externally by main_window,
        # so we don't call it here directly.
        # self._init_ribbon() # This line was in the instruction but seems to imply a refactor not explicitly requested.
                              # Keeping setup_top_bar as the public interface for now.

    def setup_top_bar(self, main_layout):
        """Tworzy i zwraca ramkÄ™ gÃ³rnego paska narzÄ™dzi."""
        top_bar_frame = QFrame()
        top_bar_frame.setFrameShape(QFrame.StyledPanel)
        top_bar_frame.setFrameShadow(QFrame.Raised)
        top_bar_frame.setFixedHeight(50)
        top_bar_layout = QHBoxLayout(top_bar_frame)
        top_bar_layout.setContentsMargins(5, 5, 5, 5)
        top_bar_frame.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)

        # --- LEWA STRONA PASKA (Menu, Ustawienia, Akcje) ---

        self.main_window.toggle_menu_button = QPushButton("â˜°")  # UÅ¼ywam standardowego znaku menu
        self.main_window.toggle_menu_button.setFixedSize(32, 32)
        self.main_window.toggle_menu_button.setToolTip("PokaÅ¼/ukryj panel filtrÃ³w (F1)")
        # ZakÅ‚adamy, Å¼e metoda toggle_left_panel istnieje w main_window
        if hasattr(self.main_window, 'toggle_left_panel'):
            self.main_window.toggle_menu_button.clicked.connect(self.main_window.toggle_left_panel)
        top_bar_layout.addWidget(self.main_window.toggle_menu_button)

        self.main_window.settings_button = QPushButton("Ustawienia")
        if hasattr(self.main_window, 'show_settings_dialog'):
            self.main_window.settings_button.clicked.connect(self.main_window.show_settings_dialog)
        top_bar_layout.addWidget(self.main_window.settings_button)

        top_bar_layout.addWidget(self.create_separator())

        top_bar_layout.addWidget(QLabel("MiesiÄ…c:"))
        self.main_window.date_combo = QComboBox()
        self.main_window.date_combo.setMinimumWidth(120)
        if hasattr(self.main_window, 'refresh_data'):
            self.main_window.date_combo.currentIndexChanged.connect(self.main_window.refresh_data)
        top_bar_layout.addWidget(self.main_window.date_combo)

        self.main_window.load_data_button = QPushButton("ðŸš€ Pobierz Dane")
        self.main_window.load_data_button.setToolTip("Kliknij, aby poÅ‚Ä…czyÄ‡ siÄ™ z bazÄ… i zaÅ‚adowaÄ‡ dane.")
        top_bar_layout.addWidget(self.main_window.load_data_button)
        self.main_window.load_data_button.setVisible(True)

        self.main_window.refresh_button = QPushButton("OdÅ›wieÅ¼")
        self.main_window.refresh_button.setToolTip("OdÅ›wieÅ¼ dane dla bieÅ¼Ä…cych filtrÃ³w")
        if hasattr(self.main_window, 'refresh_data'):
            self.main_window.refresh_button.clicked.connect(self.main_window.refresh_data)
        top_bar_layout.addWidget(self.main_window.refresh_button)
        self.main_window.refresh_button.setVisible(False)

        self.main_window.show_audit_button = QPushButton("Historia Zmian")
        if hasattr(self.main_window, 'show_audit_log_window'):
            self.main_window.show_audit_button.clicked.connect(self.main_window.show_audit_log_window)
        top_bar_layout.addWidget(self.main_window.show_audit_button)

        self.main_window.staffing_details_button = QPushButton("Obsada")
        if hasattr(self.main_window, 'show_staffing_details_window'):
            self.main_window.staffing_details_button.clicked.connect(self.main_window.show_staffing_details_window)
        top_bar_layout.addWidget(self.main_window.staffing_details_button)

        self.main_window.training_report_button = QPushButton("ðŸŽ“ Raport SzkoleÅ„")
        self.main_window.training_report_button.setToolTip("OtwÃ³rz raport postÄ™pu Å›cieÅ¼ek szkoleniowych")
        if hasattr(self.main_window, 'show_training_status_window'):
            self.main_window.training_report_button.clicked.connect(self.main_window.show_training_status_window)
        top_bar_layout.addWidget(self.main_window.training_report_button)

        # Ikony Excel, Teams, Outlook
        self.main_window.export_button = QPushButton()
        self.main_window.export_button.setIcon(self._load_icon("icons/excel.png"))
        self.main_window.export_button.setIconSize(QSize(24, 24))
        self.main_window.export_button.setFixedSize(32, 32)
        self.main_window.export_button.setToolTip("Eksportuj do Excel (.xlsx)")
        if hasattr(self.main_window, 'export_schedule_to_excel'):
            self.main_window.export_button.clicked.connect(self.main_window.export_schedule_to_excel)
        top_bar_layout.addWidget(self.main_window.export_button)

        self.main_window.teams_chat_button = QPushButton()
        self.main_window.teams_chat_button.setIcon(self._load_icon("icons/teams.png"))
        self.main_window.teams_chat_button.setIconSize(QSize(24, 24))
        self.main_window.teams_chat_button.setFixedSize(32, 32)
        self.main_window.teams_chat_button.setToolTip("OtwÃ³rz czat w Teams (Ctrl+T)")
        if hasattr(self.main_window, 'open_teams_chat_for_selection'):
            self.main_window.teams_chat_button.clicked.connect(self.main_window.open_teams_chat_for_selection)
        self.main_window.teams_chat_button.setEnabled(False)
        top_bar_layout.addWidget(self.main_window.teams_chat_button)

        self.main_window.send_email_button = QPushButton()
        self.main_window.send_email_button.setIcon(self._load_icon("icons/outlook.png"))
        self.main_window.send_email_button.setIconSize(QSize(24, 24))
        self.main_window.send_email_button.setFixedSize(32, 32)
        self.main_window.send_email_button.setToolTip("WyÅ›lij e-mail (Ctrl+O)")
        if hasattr(self.main_window, 'send_email_to_selection'):
            self.main_window.send_email_button.clicked.connect(self.main_window.send_email_to_selection)
        self.main_window.send_email_button.setEnabled(False)
        top_bar_layout.addWidget(self.main_window.send_email_button)

        self.main_window.schedule_control_button = QPushButton("ZarzÄ…dzaj Grafikiem")
        if hasattr(self.main_window, 'show_schedule_control_dialog'):
            self.main_window.schedule_control_button.clicked.connect(self.main_window.show_schedule_control_dialog)
        top_bar_layout.addWidget(self.main_window.schedule_control_button)

        # --- KLUCZOWY ELEMENT: Wypychacz (Spacer) ---
        top_bar_layout.addStretch()

        # --- PRAWA STRONA PASKA (Tylko Powiadomienia) ---

        self.main_window.notification_btn = QPushButton()
        icon = self._load_icon("icons/notification.png")
        if icon.isNull():
             self.main_window.notification_btn.setText("ðŸ””")
        else:
             self.main_window.notification_btn.setIcon(icon)

        self.main_window.notification_btn.setIconSize(QSize(24, 24))
        self.main_window.notification_btn.setFixedSize(32, 32)
        self.main_window.notification_btn.setToolTip("Powiadomienia")

        self.main_window.notification_btn.clicked.connect(self.toggle_notifications)
        self.main_window.notification_btn.setVisible(app_settings.ENABLE_NOTIFICATION_CENTER)

        top_bar_layout.addWidget(self.main_window.notification_btn)

        return top_bar_frame

    def _load_icon(self, path):
        import os
        from debug_utils import debug_print, log_error
        try:
            full_path = resource_path(path)
            debug_print(f"Loading icon: {path} -> {full_path}")
            if not os.path.exists(full_path):
                log_error(f"ICON NOT FOUND: {full_path}")
                return QIcon()
            
            icon = QIcon(full_path)
            if icon.isNull():
                 log_error(f"FAILED TO LOAD ICON: {full_path} (Obiekt QIcon jest null)")
            else:
                 # SprawdÅºmy czy ikona ma faktycznie jakieÅ› rozmiary na starcie
                 available_sizes = icon.availableSizes()
                 if not available_sizes:
                     debug_print(f"ICON LOADED but has NO available sizes: {full_path}")
                 else:
                     debug_print(f"ICON LOAED SUCCESS: {full_path}, Sizes: {available_sizes}")

            return icon
        except Exception as e:
            log_error(f"EXCEPTION loading icon {path}: {e}")
            return QIcon()

    def toggle_notifications(self):
        """PrzeÅ‚Ä…cza widocznoÅ›Ä‡ panelu powiadomieÅ„."""
        if hasattr(self.main_window, 'notification_drawer') and self.main_window.notification_drawer:
            if self.main_window.notification_drawer.isHidden():
                self.main_window.notification_drawer.show()
            self.main_window.notification_drawer.toggle()

    def create_separator(self):
        separator = QFrame()
        separator.setFrameShape(QFrame.VLine)
        separator.setFrameShadow(QFrame.Sunken)
        return separator

    def setup_date_combo(self):
        """Konfiguruje combobox z datami, uwzglÄ™dniajÄ…c uprawnienia."""
        if not hasattr(self.main_window, 'date_combo'):
            return

        self.main_window.date_combo.blockSignals(True)
        current_date = datetime.now()
        months_to_show = []
        year, month = current_date.year, current_date.month

        for i in range(getattr(app_settings, 'HISTORY_MONTHS', 3), 0, -1):
            prev_month, prev_year = (month - i, year)
            while prev_month <= 0:
                prev_month += 12
                prev_year -= 1
            months_to_show.append((prev_year, prev_month))

        months_to_show.append((year, month))

        # Zawsze pokazujemy przyszÅ‚y miesiÄ…c (kontrola dostÄ™pu przy prÃ³bie zaÅ‚adowania)
        next_month, next_year = (month + 1, year)
        if next_month > 12:
            next_month = 1
            next_year += 1
        months_to_show.append((next_year, next_month))

        # Szukamy indeksu dla bieÅ¼Ä…cej daty (startowej)
        current_data_tuple = (current_date.year, current_date.month)
        
        self.main_window.date_combo.clear()
        
        found_index = -1
        for idx, (y, m) in enumerate(months_to_show):
            self.main_window.date_combo.addItem(f"{y}-{m:02d}", (y, m))
            if (y, m) == current_data_tuple:
                found_index = idx

        # JeÅ›li znaleziono bieÅ¼Ä…cy miesiÄ…c, ustaw go. W przeciwnym razie ostatni.
        if found_index != -1:
             self.main_window.date_combo.setCurrentIndex(found_index)
        else:
             self.main_window.date_combo.setCurrentIndex(self.main_window.date_combo.count() - 1)
             
        self.main_window.date_combo.blockSignals(False)
