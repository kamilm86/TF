# admin_handlers.py
from PySide6.QtWidgets import QApplication
from debug_utils import debug_print, log_error
from db_connector import load_all_app_settings
from ui_utils import show_warning_dialog, show_info_dialog

class AdminCommandHandler:
    """
    Obsługuje komendy administracyjne otrzymane przez Service Broker.
    Wydzielone z głównego okna dla lepszej czytelności.
    """
    def __init__(self, main_window):
        self.main_window = main_window

    def handle_refresh_permissions(self):
        """Odświeża uprawnienia użytkownika na żądanie administratora."""
        debug_print("Wykonywanie zdalnego odświeżania uprawnień...")
        load_all_app_settings()
        
        if hasattr(self.main_window, 'check_user_permissions'):
            self.main_window.check_user_permissions()

        # Opcjonalnie: Jeśli rola się zmieniła, odśwież widok
        if hasattr(self.main_window, 'update_buttons_visibility'):
            self.main_window.update_buttons_visibility()
            
        if hasattr(self.main_window, 'statusBar'):
            self.main_window.statusBar().showMessage("Uprawnienia zostały zaktualizowane zdalnie.", 5000)

    def handle_kill_session(self, reason):
        """Zamyka aplikację na żądanie administratora."""
        reason_text = reason if reason else "Administrator wymusił zamknięcie sesji."
        debug_print(f"Wykonywanie zdalnego zamknięcia sesji. Powód: {reason_text}")

        # Zapisz sesję jako zamkniętą zdalnie
        if hasattr(self.main_window, 'session_manager'):
            self.main_window.session_manager.end_session(exit_type="RemoteKill")

        # Pokaż komunikat (blokujący, żeby użytkownik przeczytał)
        show_warning_dialog(self.main_window, "Sesja zakończona",
                            f"Twoja sesja została zamknięta przez administratora.\n\nPowód: {reason_text}")

        # Zamknij aplikację
        QApplication.quit()

    def handle_message(self, message):
        """Wyświetla wiadomość od administratora."""
        if message:
            show_info_dialog(self.main_window, "Wiadomość od Administratora", message)
